"Это решение можно использовать в любых инвестиционных продуктах.
 Клиенты будут рады увидеть процент доходности за период."

Зачастую в инвестиционных программах клиент не получает информации о проценте своей доходности. Хотя, несомненно, такой запрос от клиентов есть. Их хочется понимать, насколько эффективно отработали вложенные средства. Причём за любой период.

Если вложенная сумма одна на старте, как в банковском депозите, то задача тривиальна, и решается математически достаточно просто. Делим прирост капитала на сумму средств, инвестированных в начале периода. Умножаем на 100%.

Однако, такая простая задачка бывает лишь в продукте «банковский депозит, без возможности пополнения».
В продуктовых линейках банков, форекс-брокеров, инвест-брокеров встречаются случаи посложнее. Например, если клиент инвестировал в начале года 5000 долларов, а 12 апреля и 25 августа добавлял ещё по 8000 долларов, и также выводи часть средств 5 июня (-6000 долларов), 8 сентября (-3000 долларов). В итоге 7 октября инвестор закрыл счёт, забрав остальное (-13000 долларов).

Суммируя все операции на счёте инвестора, легко понять, что он заработал 1000 долларов. Но каков процент доходности был у такого инвестора? Как его посчитать? Ведь в нашей задаче нет единой суммы средств, которая «работала» весь инвестиционный период.

Считать относительно первой инвестированной суммы 5000 долларов – не корректно. Ведь начиная с апреля, было добавлено ещё 8000. И с этого момента суммарный работающий баланс капитала был равен уже 13000. В дальнейшем баланс также менялся.

Расчёта процента доходности по инвестициям сводится к поиску процента, под который можно было класть инвестируемые средства на депозит, либо же брать заёмные в кредит (в случае убытка). Этот искомый процент назовём «ставка рефинансирования». Он показывает насколько стоимость денег уменьшится через год. Так, при ставке рефинансирования 10%, каждые 100 долларов сегодня эквивалентны 110 долларам через год.

Опишем задачу математически.

Обозначим суммы вводов за M - массив операций на счёте инвестора. Положительных в случае ввода, и отрицательных в случае вывода.
i - Количество дней прошедших с начала периода рассчитываемой доходности.

Если за одни сутки было несколько операций ввода-вывода, то в M[i] этого дня следует сохранить сумму всех этих операций.

Примечания: 
* если на счёте уже имелась какая-то сумма на момент начала расчёта, то нам следует внести её как ввод на счёт;
* если на счёте имелась какая-то сумма на момент окончания расчёта доходности, то нам следует внести её как вывод со счёта.

В решении мы приводим суммы всех операций (ввод и вывод со счёта) к единой норме, рассчитывая стоимость старых денег к дате завершения расчёта. Причём изначально мы принимаем этот процент равным 0%. Ему соответствует коэффициент прироста равный 1.

Пусть
x – искомый коэффициент увеличения стоимости инвестиций за сутки.
i – количество дней жизни инвест-счёта.

Тогда для решения задачи нужно решить уравнение: 
M[1] • POWER(x, i-1) + M[2] • POWER(x, i-2) + …    … + M[i] • POWER(x, i-i) = 0

Это степенное уравнение степени больше 3.
Общего аналитического решения нет. Зато для нашего случая известно, что функция гладкая, и имеет одно и только одно решение, находимое итерационно методом приближения.

Взяв изначально x=1, мы суммируем полученные приведённые суммы в переменную «_profit_iter». Смотрим, размер прибыли с учётом изменяющейся стоимости денег (ежедневно стоимость денег претерпевает инфляцию доходности равную «_yield_day_mult»). 

Мы находим решение в цикле, постоянно приближаясь к решению. Искомое значение – коэффициент дневной доходности - переменная «_yield_day_mult». Стартовое значение «_yield_day_mult» = 1. Это соответствует 0%.
Каждый цикл мы должны скорректировать «_yield_day_mult» в сторону правильного решения. Либо увеличить, либо уменьшить.

Если Видим, что «_profit_iter» положительный, значит, мы недооценили процент доходности. Если «_profit_iter» отрицательный, то мы переоценили.
Допустим мы поняли, что «_yield_day_mult» следует увеличить. Значит мы ищем его в интервале между 1 и каким-то большим значением «_yield_day_mult_max».

В программировании часто используется метод половинного деления. В случае же поиска правильного коэффициента доходности мы также можем применить этот известный алгоритм, но с оговоркой. Мы будем рассчитывать новое значение «_yield_day_mult» не как среднее арифметическое, а как среднегеометрическое. Так как речь идёт о коэффициенте кратного роста, а не о линейном параметре.

Новый «_yield_day_mult» будет равен корню из произведения старого «_yield_day_mult» и максимального значения «_yield_day_mult_max».

Как правило, хватает 25-50 итераций для нахождения решения. 
